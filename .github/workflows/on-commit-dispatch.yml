name: On Commit Dispatch

on:
  repository_dispatch:
    types: [sync-from-ui-commit]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ui-server
        uses: actions/checkout@v3

      - name: Download and Build UI
        uses: ./.github/actions/download-and-build-ui
        with:
          ref: ${{ github.event.client_payload.ref }}

      - name: Commit changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add .
          git commit -m "Sync from UI commit ${{ github.sha }}"
          git push

      - name: Docker meta for Commit image
        id: meta_commit
        uses: docker/metadata-action@v4
        with:
          images: temporaliotest/ui
          tags: |
            type=sha,format=short,event=branch
            latest

      - name: Docker Build and Push
        uses: ./.github/actions/docker-build-push
        with:
          images: temporaliotest/ui
          tags: ${{ steps.meta_commit.outputs.tags }}
          labels: ${{ steps.meta_commit.outputs.labels }}
