# UI ‚Üí UI-Server Release Sync System

This project automates synchronization between the `temporalio/ui`, `temporalio/ui-server`, and `temporalio/saas-ui-server` repositories. It supports two distinct paths based on events in the `ui` repo:

---

## üß≠ Repo Roles and Responsibilities

* **`temporalio/ui`**: The source of truth for UI code. Exports a `server/` directory that is reused downstream. Pushes to `main` and release publishing both trigger downstream sync workflows.

* **`temporalio/ui-server`**: The backend server repo that embeds the `ui/server` code. It receives dispatches from the `ui` repo and either builds and pushes a Docker image (on commit) or executes a full release flow with GoReleaser (on tag).

* **`temporalio/saas-ui-server`**: The production deployment of the `ui-server` backend. It receives dispatches from `ui-server`, updates its `go.mod` to the new release version, and pushes its own Docker image.

---

## üöÄ Workflow Summary

### 1. **On Push to `main` in `ui`**

* Triggers a `repository_dispatch` event to `ui-server` with event type: `sync-from-ui-commit`
* Payload:

  ```json
  {
    "ref": "main",
    "source": "push"
  }
  ```
* `ui-server` uses the `download-and-build-ui` action to clone `ui`, build, and copy the `server/` directory
* Commits changes to `main`
* Uses the `docker-build-push` action to build and push a Docker image tagged with the short commit SHA

---

### 2. **On Release Published in `ui`**

* Triggers a `repository_dispatch` event to `ui-server` with event type: `sync-from-ui-release`
* Payload:

  ```json
  {
    "ref": "v1.2.3",
    "release_tag": "v1.2.3",
    "release_url": "https://github.com/temporalio/ui/releases/tag/v1.2.3",
    "source": "release"
  }
  ```
* `ui-server` uses the `download-and-build-ui` action to clone `ui`, build, and copy the `server/` directory
* Uses `peter-evans/create-pull-request` to create and auto-merge a PR
* Uses `softprops/action-gh-release` to create a GitHub release tagged `v1.2.3`
* Uses `goreleaser/goreleaser-action` to run `GoReleaser` and build and push binaries and Docker image tagged `v1.2.3`
* Triggers a dispatch to `saas-ui-server` to update its dependency

---

## ‚ôªÔ∏è Composite Actions

To avoid duplication, reusable composite actions are defined in:

### Download and Build UI

```
.github/actions/download-and-build-ui/action.yml
```

This action downloads the `temporalio/ui` repository, installs dependencies, builds the server, and copies the necessary files to the `ui-server` directory. It accepts the following inputs:
- `ref`: The commit SHA of `temporalio/ui` to build.
- `token`: GitHub token for authentication.

### Docker Build and Push

```
.github/actions/docker-build-push/action.yml
```

This action sets up QEMU and Buildx, logs into DockerHub, and builds and pushes Docker images. It accepts the following inputs:
- `images`: Docker images to build and push.
- `tags`: Docker tags to apply.
- `labels`: Docker labels to apply.

---

## üîß Authentication via GitHub App

Instead of using PATs, this setup uses a GitHub App for secure access and automation. All actions requiring elevated permissions use a token generated by:

```yaml
- name: Prepare checkout token
  id: generate_token
  uses: tibdex/github-app-token@v1
  with:
    app_id: ${{ secrets.TEMPORAL_CICD_APP_ID }}
    private_key: ${{ secrets.TEMPORAL_CICD_PRIVATE_KEY }}
```

Use `steps.generate_token.outputs.token` in subsequent steps.

### Required Secrets

| Secret                      | Description                       |
| --------------------------- | --------------------------------- |
| `TEMPORAL_CICD_APP_ID`      | GitHub App ID for CI/CD workflows |
| `TEMPORAL_CICD_PRIVATE_KEY` | Private key for signing requests  |

---

## üì¶ Docker Tags

| Trigger           | Tagging Scheme                        |
| ----------------- | ------------------------------------- |
| Push to `main`    | `sha-<shortsha>` (e.g. `sha-a1b2c3d`) |
| Release published | `v1.2.3` (versioned) and `latest`     |

---

## üìÅ Workflows

| Repo        | Workflow                  | Purpose                                                        |
| ----------- | ------------------------- | -------------------------------------------------------------- |
| `ui`        | `dispatch-on-push.yml`    | Triggers `sync-from-ui-commit` to `ui-server`                  |
| `ui`        | `dispatch-on-release.yml` | Triggers `sync-from-ui-release` to `ui-server`                 |
| `ui-server` | `on-commit-dispatch.yml`  | Sync, commit, Docker (no release)                              |
| `ui-server` | `on-release-dispatch.yml` | Full release, GoReleaser, Docker, dispatch to `saas-ui-server` |

---

This setup enables continuous and tag-based updates of UI logic into downstream services, while keeping version control and traceability across Docker tags and GitHub releases.

---

## üìÑ Files Used in This Session

- .github/actions/download-and-build-ui/actions.yaml
- .github/actions/docker-build-push/action.yml
- .github/workflows/on-commit-dispatch.yml
- .github/workflows/on-release-dispatch.yml
- .gitignore
- go.mod
- .aider.requirements.md

# UI Release Strategy

This document outlines the release strategy for the `temporalio/ui`, `temporalio/ui-server`, and `temporalio/saas-ui-server` repositories.

## Overview

The release process is designed to ensure smooth synchronization and deployment across the three repositories, leveraging GitHub Actions for automation.

## Repositories

- **`temporalio/ui`**: The primary source of UI code. Changes here trigger downstream actions.
- **`temporalio/ui-server`**: Integrates UI code and handles backend logic.
- **`temporalio/saas-ui-server`**: Deploys the integrated UI and backend to production.

## Release Process

1. **Commit to `main` in `ui`**:
   - Triggers a dispatch to `ui-server`.
   - `ui-server` builds and pushes a Docker image.

2. **Release in `ui`**:
   - Triggers a dispatch to `ui-server`.
   - `ui-server` creates a release, builds Docker images, and dispatches to `saas-ui-server`.

3. **Deployment in `saas-ui-server`**:
   - Updates dependencies and deploys the new version.

## Automation

- **GitHub Actions**: Used for building, testing, and deploying across repositories.
- **Composite Actions**: Reusable actions for common tasks like building Docker images.

## Security

- **GitHub App Authentication**: Secure token generation for accessing repositories.
- **Secrets Management**: Sensitive information is stored in GitHub Secrets.

## Conclusion

This strategy ensures efficient and reliable updates across the UI ecosystem, maintaining consistency and quality in deployments.
