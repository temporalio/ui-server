import{w as p}from"./singletons.c162f96b.js";import{ac as b}from"./index.9b814669.js";import{A as a}from"./workflow-actions.6f88149c.js";import{g as d}from"./auth-user.afd785c8.js";import{p as w}from"./persist-store.14d63d79.js";import{t as y}from"./versions.26e71abe.js";import{s as u}from"./parse-with-big-int.0036a80a.js";import{r as i,a as c}from"./route-for-api.e80b6624.js";import{i as h}from"./version-check.d006b302.js";const I=e=>e.map(o=>o.runId).reduce((o,r,n,m)=>(o+=`RunId="${r}"`,n!==m.length-1&&(o+=" OR "),o),""),T=e=>{const t=d().email;switch(e){case a.Cancel:return{cancellationOperation:{identity:t}};case a.Terminate:return{terminationOperation:{identity:t}};default:return{}}},O=({id:e,runId:t})=>({workflowId:e,runId:t}),f=(e,t)=>{const o={jobId:t.jobId,namespace:t.namespace,reason:t.reason,...T(e)};if(t.workflows)return h(b(y),"1.19")?{...o,executions:t.workflows.map(O)}:{...o,visibilityQuery:I(t.workflows)};if(t.query)return{...o,visibilityQuery:t.query}};async function E(e){const t=i("batch-operations",{namespace:e.namespace}),o=f(a.Cancel,e);await c(t,{options:{method:"POST",body:u(o)},notifyOnError:!1}),s.set({jobId:o.jobId,namespace:o.namespace})}async function Q(e){const t=i("batch-operations",{namespace:e.namespace}),o=f(a.Terminate,e);await c(t,{options:{method:"POST",body:u(o)},notifyOnError:!1}),s.set({jobId:o.jobId,namespace:o.namespace})}async function l({namespace:e,jobId:t}){return new Promise((o,r)=>{k({namespace:e,jobId:t}).then(({state:n,completeOperationCount:m})=>{n==="Failed"?r():n!=="Running"?o(m):setTimeout(()=>{try{o(l({namespace:e,jobId:t}))}catch{r()}},5e3)})})}async function k({jobId:e,namespace:t},o=fetch){const r=i("batch-operation.describe",{namespace:t}),n=await c(r,{params:{jobId:e},request:o});return C(n)}const C=e=>({...e,startTime:e.startTime,closeTime:e.closeTime,totalOperationCount:parseInt(e.totalOperationCount,10),completeOperationCount:parseInt(e.completeOperationCount,10),failureOperationCount:parseInt(e.failureOperationCount,10)});async function V(e,t=fetch){const o=i("batch-operations",{namespace:e}),r=await c(o,{request:t});return{nextPageToken:r.nextPageToken,operations:r.operationInfo?r.operationInfo.map(g):[]}}const g=e=>({startTime:e.startTime,closeTime:e.closeTime,jobId:e.jobId,state:e.state}),s=p();s.subscribe(async e=>{e&&await l(e).then(()=>s.set(void 0))});const _=w("auto-refresh-batch-operation",!1);export{_ as a,Q as b,E as c,k as d,s as i,V as l};
