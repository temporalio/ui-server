import{d,r as et,w as g}from"./entry.gllb_r-v.js";import{p as E}from"./stores.m0PGeCMI.js";import{t as p}from"./translate.HrioCK44.js";import{f as nt}from"./workflow-counts.5W1DfQiF.js";import{D as x}from"./scheduler.IHo1m08M.js";import{A as I}from"./workflow-actions.-K4W_iAA.js";import{e as rt,c as it}from"./decode-payload.HEnMgTPI.js";import{f as st,g as at}from"./screaming-enums.3wTTsLmE.js";import{w as ct}from"./write-actions-are-allowed.WR3TCpDO.js";import{s as ft}from"./index.X2NQ_bni.js";import{a as T}from"./auth-user.h8py94Ls.js";import{i as D,m as U}from"./version-check.HLZIw2tw.js";import{c as L,t as A}from"./versions.AkSstVVc.js";import{s as lt}from"./filters.n1K7pjtU.js";import{e as j,s as ut}from"./encode-payload.FUFzVI6b.js";import{b as dt,p as wt,a as w,r as m,c as mt,d as kt,e as yt}from"./route-for-api.bDUXrXZd.js";import{s as b}from"./parse-with-big-int.e3oI4SEy.js";import{i as ht,c as xt,t as z,d as Et}from"./format-time.PmxHXK_V.js";import{a as gt}from"./events-service.BZDj1JUO.js";import{v as pt}from"./toaster.dlw4LFal.js";const It=(t=[])=>t.map(o=>{const e=ft(o,!0),n=o.activityId;return{...e,id:n}}),bt=t=>t?t.map(o=>({...o,state:at(o.state)})):[],Wt=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((e,[n,r])=>({...e,[n]:rt(r)}),{})},S=t=>{var R,F,N,$,V,q,B,Q;const o=Wt(t.workflowExecutionInfo.searchAttributes),e=t.workflowExecutionInfo.memo,n=t.workflowExecutionInfo.type.name,r=t.workflowExecutionInfo.execution.workflowId,i=t.workflowExecutionInfo.execution.runId,a=t.workflowExecutionInfo.startTime,s=t.workflowExecutionInfo.closeTime,c=t.workflowExecutionInfo.executionTime,l=st(t.workflowExecutionInfo.status),u=l==="Running",k=t.workflowExecutionInfo.historyLength,f=t.workflowExecutionInfo.historySizeBytes,y=`/workflows/${r}/${i}`,h=((F=(R=t==null?void 0:t.executionConfig)==null?void 0:R.taskQueue)==null?void 0:F.name)||((N=t==null?void 0:t.workflowExecutionInfo)==null?void 0:N.taskQueue),v=($=t==null?void 0:t.workflowExecutionInfo)==null?void 0:$.mostRecentWorkerVersionStamp,H=(V=t==null?void 0:t.workflowExecutionInfo)==null?void 0:V.assignedBuildId,J=(q=t==null?void 0:t.workflowExecutionInfo)==null?void 0:q.parentNamespaceId,M=(B=t==null?void 0:t.workflowExecutionInfo)==null?void 0:B.parentExecution,X=t.workflowExecutionInfo.stateTransitionCount,Y=(Q=t.executionConfig)==null?void 0:Q.defaultWorkflowTaskTimeout,Z=It(t.pendingActivities),tt=(t==null?void 0:t.pendingChildren)??[],ot=bt(t==null?void 0:t.pendingNexusOperations);return{name:n,id:r,runId:i,startTime:a,endTime:s,executionTime:c,status:l,historyEvents:k,historySizeBytes:f,searchAttributes:o,memo:e,url:y,taskQueue:h,assignedBuildId:H,mostRecentWorkerVersionStamp:v,pendingActivities:Z,pendingChildren:tt,pendingNexusOperations:ot,parentNamespaceId:J,parent:M,stateTransitionCount:X,isRunning:u,defaultWorkflowTaskTimeout:Y,get canBeTerminated(){return u&&ct()}}},P=t=>(t.executions||[]).map(o=>S({workflowExecutionInfo:o})),Tt=(t,o)=>{var e;return((e=t==null?void 0:t.visibilityStore)==null?void 0:e.includes("elasticsearch"))||D(o,"1.19")},At=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},C=d([E],([t])=>{var o,e,n;return(n=(e=(o=t.data)==null?void 0:o.settings)==null?void 0:e.runtimeEnvironment)==null?void 0:n.isCloud}),K=d([L,A,C],([t,o,e])=>Tt(t,o)||e);d([L,C],([t,o])=>At(t)||o);const St={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Pt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Ct=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Ot=t=>{if(typeof t!="string")return!1;for(const o of Pt)if(o===t)return!0;return!1},vt=(t,o,e)=>{const n=St[t];return o==="All"?"":ht(o)||xt(o)?e||x(K)?`${n} > "${z(o)}"`:`${n} BETWEEN "${z(o)}" AND "${Et()}"`:`${n}="${o}"`},Rt=(t,o)=>Object.entries(t).map(([e,n])=>{if(Ot(e)&&Ct(n))return vt(e,n,o)}).filter(Boolean),Ft=(t,o=!1)=>Rt(t,o).join(" and ");function Nt(t){console.error("Unhandled action:",t)}const $t=(t,o)=>{let e;switch(t){case I.Cancel:e=p("workflows.canceled");break;case I.Reset:e=p("workflows.reset");break;case I.Terminate:e=p("workflows.terminated");break;default:Nt(t)}return o?p("workflows.workflow-action-reason-placeholder-with-email",{action:e,email:o}):p("workflows.workflow-action-reason-placeholder",{action:e})},_=({action:t,reason:o,email:e})=>{const n=$t(t,e);return o?[o.trim(),n].join(" "):n},O=async(t,o,e=fetch,n=!1)=>{const r=o.query||Ft(o,n);let i;try{i=decodeURIComponent(r)}catch{i=r}const a=n?"workflows.archived":"workflows";let s="";const c=f=>{var y,h;mt(f),(y=f==null?void 0:f.body)!=null&&y.message||f!=null&&f.status?s=((h=f==null?void 0:f.body)==null?void 0:h.message)??`Error fetching workflows: ${f.status}: ${f.statusText}`:s="Error fetching workflows: Server failed to respond"},l=m(a,{namespace:t}),{executions:u,nextPageToken:k}=await w(l,{params:{query:i},onError:c,handleError:c,request:e})??{executions:[],nextPageToken:""};return{workflows:P({executions:u}),nextPageToken:String(k),error:s}},xo=async({namespace:t,workflowId:o,url:e},n=fetch)=>{var u;const r="workflows",i=e??dt(t),a=wt(r,{namespace:t}),s=i+a,{executions:c}=await w(s,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:n})??{executions:[]},l=(u=P({executions:c}))==null?void 0:u[0];return{runId:l==null?void 0:l.runId}},Eo=async(t,o=fetch,e=!1)=>{const n=e?"workflows.archived":"workflows";let r=!0;const i=s=>{(kt(s)||yt(s))&&(r=!1)},a=m(n,{namespace:t});return await w(a,{params:{pageSize:"1"},onError:i,handleError:i,request:o}),{authorized:r}},go=async(t,o,e=fetch)=>O(t,o,e,!0);async function po(t,o=fetch){const e=m("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(e,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(n=>({workflow:S(n)})).catch(n=>({error:n}))}async function Io({workflow:t,namespace:o,reason:e}){const n=m("workflow.terminate",{namespace:o,workflowId:t.id}),r=x(T).email,i=_({reason:e,action:I.Terminate,email:r});return await w(n,{options:{method:"POST",body:b({reason:i,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function bo({namespace:t,workflow:{id:o,runId:e}},n=fetch){const r=m("workflow.cancel",{namespace:t,workflowId:o});return w(r,{request:n,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":e}})}async function Wo({namespace:t,workflow:{id:o,runId:e},name:n,input:r}){const i=m("workflow.signal",{namespace:t,workflowId:o,signalName:n}),a=await j(r),s=x(E).data.settings,c=(s==null?void 0:s.version)??"",u=D(c,"2.22")?{signalName:n,workflowExecution:{workflowId:o,runId:e},input:{payloads:a}}:{signalName:n,input:{payloads:a},params:{"execution.runId":e}};return w(i,{notifyOnError:!1,options:{method:"POST",body:b(u)}})}async function To({namespace:t,workflow:{id:o,runId:e},eventId:n,reason:r,reapplyType:i}){const a=m("workflow.reset",{namespace:t,workflowId:o}),s=x(T).email,c=_({action:I.Reset,reason:r,email:s}),l={workflowExecution:{workflowId:o,runId:e},workflowTaskFinishEventId:n,resetReapplyType:i,requestId:pt(),reason:c};return w(a,{notifyOnError:!1,options:{method:"POST",body:b(l)},params:{"execution.runId":e}})}async function Ao(t,o=fetch){const e=r=>{console.error(r)},n=m("workflow",t);return w(n,{request:o,onError:e,handleError:e}).then(S)}async function So(t,o,e){if(!x(G))return[];try{let n=`ParentWorkflowId = "${o}"`;e&&(n+=` AND ParentRunId = "${e}"`);const{workflows:r}=await O(t,{query:n});return r}catch{return[]}}const Vt=t=>{if(!t.length)return{};const o={};return t.forEach(e=>{o[e.attribute]=ut(e.value)}),o};async function Po({namespace:t,workflowId:o,taskQueue:e,workflowType:n,input:r,searchAttributes:i}){const a=m("workflow",{namespace:t,workflowId:o});let s;if(r)try{s=await j(r)}catch{console.error("Could not decode input for starting workflow")}const c=b({workflowId:o,taskQueue:{name:e},workflowType:{name:n},input:s?{payloads:s}:null,searchAttributes:i.length===0?null:{indexedFields:{...Vt(i)}}});return w(a,{notifyOnError:!1,options:{method:"POST",body:c}})}const Co=async({namespace:t,workflowType:o,workflowId:e})=>{var i,a,s;const n=c=>{console.error(c)},r={input:"",searchAttributes:void 0};try{let c="";o&&e?c=`WorkflowType = "${o}" AND WorkflowId = "${e}"`:o?c=`WorkflowType = "${o}"`:e&&(c=`WorkflowId = "${e}"`);const l=m("workflows",{namespace:t}),u=await w(l,{params:{query:c,pageSize:"1"},handleError:n});if(!((i=u==null?void 0:u.executions)!=null&&i[0]))return r;const k=P(u)[0],y=await gt({namespace:t,workflowId:k.id,runId:k.runId}),h=await it((a=y==null?void 0:y.attributes)==null?void 0:a.input,t,x(E).data.settings,x(T).accessToken);return{input:b(h==null?void 0:h.payloads[0]),searchAttributes:(s=k==null?void 0:k.searchAttributes)==null?void 0:s.indexedFields}}catch{return r}},qt=300,Bt=async(t,o,e)=>{o.set(!0);try{await e()}catch(n){console.error(n)}t.set(!1),setTimeout(()=>{o.set(!1)},qt)},Qt=d([E],([t])=>{var o,e,n;return!!((n=(e=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:e.capabilities)!=null&&n.countGroupByExecutionStatus)}),Oo=d([E,A],([t,o])=>{var r,i,a;const e=U("1.23.0",o),n=!!((a=(i=(r=t.data)==null?void 0:r.systemInfo)==null?void 0:i.capabilities)!=null&&a.prefixSearch);return e||n}),zt=g(0),Dt=d([E],([t])=>{var o,e;return(e=(o=t.data)==null?void 0:o.settings)==null?void 0:e.hideWorkflowQueryErrors}),G=d([C,A],([t,o])=>t||U("1.23.0",o)),Ut=d([E],([t])=>t.url.searchParams.get("query")),Lt=d([Ut,G,lt],([t,o,e])=>o&&!e?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),jt=d([E],([t])=>t.params.namespace),Kt=d([jt,Lt,zt,K,Dt],([t,o,e,n,r])=>({namespace:t,query:o,refresh:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})),_t=t=>{Mt.set({...t,newCount:0})},Gt=t=>Kt.subscribe(({namespace:o,query:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})=>{Bt(Jt,Ht,async()=>{const{workflows:i,error:a}=await O(o,{query:e});if(t(i),n&&!x(Qt)){const s=await nt(o,e);_t(s)}a?r?W.set(p("workflows.workflows-error-querying")):W.set(a):W.set("")})}),vo=g(""),Ht=g(!0),Jt=g(!0),Mt=g({count:0,newCount:0}),W=g(""),Ro=et([],Gt),Fo=g("");export{Ht as A,W as B,Eo as a,So as b,bo as c,Co as d,Mt as e,xo as f,go as g,Ft as h,To as i,Wo as j,po as k,Ao as l,Qt as m,Fo as n,$t as o,C as p,Lt as q,zt as r,Po as s,Io as t,K as u,Oo as v,vo as w,G as x,Ro as y,Jt as z};
